-- View: per period, each active metricâ€™s normalized points (sum to 100 per period)
CREATE OR ALTER VIEW dbo.v_PeriodMetricPoints AS
WITH Periods AS (  -- choose the periods you care about
    SELECT DISTINCT period_key FROM dbo.ScoreSnapshot
    UNION
    SELECT DISTINCT period_key FROM dbo.Roster_Period
),
ActiveVersions AS (
    SELECT
        p.period_key,
        civ.complianceitemid,
        civ.weight
    FROM Periods p
    CROSS APPLY (SELECT DATEFROMPARTS(p.period_key/100, p.period_key%100, 1)) AS d(first_of_month)
    JOIN dbo.ComplianceItemVersions civ
      ON civ.effectivestartdate <= d.first_of_month
     AND (civ.effectiveenddate IS NULL OR d.first_of_month < civ.effectiveenddate)
    JOIN dbo.ComplianceItems ci
      ON ci.complianceitemid = civ.complianceitemid
     AND ci.active = 1
     AND civ.active = 1
),
Totals AS (
    SELECT period_key, SUM(CAST(weight AS decimal(18,6))) AS total_w
    FROM ActiveVersions
    GROUP BY period_key
)
SELECT
    av.period_key,
    av.complianceitemid AS metric_id,
    CAST(CASE WHEN t.total_w>0 THEN 100.0 * av.weight / t.total_w ELSE 0 END AS decimal(18,6)) AS norm_points
FROM ActiveVersions av
JOIN Totals t ON t.period_key = av.period_key;
